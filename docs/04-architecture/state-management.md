# üìä Gerenciamento de Estado com Zustand

## Vis√£o Geral

Este projeto utiliza **Zustand** como solu√ß√£o principal de gerenciamento de estado global, fornecendo uma alternativa leve e amig√°vel ao TypeScript para Redux ou Context API na gest√£o de estado em toda a aplica√ß√£o.

## üéØ Quando Usar Estado Global

### ‚úÖ Use Estado Global Para:

1. **Autentica√ß√£o e Perfil do Usu√°rio**
   - Informa√ß√µes do usu√°rio atual
   - Status de autentica√ß√£o
   - Prefer√™ncias e configura√ß√µes do usu√°rio

2. **Estado da UI Entre Componentes**
   - Tema (claro/escuro/sistema)
   - Estado aberto/recolhido da sidebar
   - Gerenciamento de modais
   - Notifica√ß√µes toast
   - Estados de carregamento para m√∫ltiplos componentes

3. **Configura√ß√£o da Aplica√ß√£o**
   - Configura√ß√µes de idioma/locale
   - Feature flags
   - Configura√ß√µes de API

4. **Comunica√ß√£o Entre Componentes**
   - Dados que m√∫ltiplos componentes n√£o relacionados precisam
   - Estado que persiste entre mudan√ßas de rota
   - Notifica√ß√µes e alertas

5. **Dados em Tempo Real**
   - Conex√µes WebSocket
   - [Sistema de notifica√ß√µes em tempo real](/docs/05-features/real-time-notifications.md)
   - Recursos colaborativos

### ‚ùå Evite Estado Global Para:

1. **Estado de Formul√°rio**
   - Use estado local com `useState` ou bibliotecas de formul√°rio como `react-hook-form`
   - S√≥ mova para global se os dados do formul√°rio precisarem persistir entre rotas

2. **Estado de UI Espec√≠fico do Componente**
   - Estados aberto/fechado de dropdown
   - Estados de carregamento locais
   - Toggles internos do componente

3. **Dados Tempor√°rios ou Ef√™meros**
   - Estados de anima√ß√£o
   - Efeitos de hover
   - Estados de foco

4. **Estado do Servidor**
   - Use React Query, SWR ou similar para cache de dados do servidor
   - S√≥ armazene no estado global se precisar transformar ou combinar dados do servidor

## üèóÔ∏è Arquitetura do Store

### Stores Dispon√≠veis

```typescript
// Core stores e hooks
import { 
  // App Store - Usu√°rio, prefer√™ncias, notifica√ß√µes
  useUser, usePreferences, useNotifications, useAppActions,
  
  // UI Store - Tema, sidebar, modais, toasts  
  useTheme, useSetTheme, useSidebarOpen, useToggleSidebar,
  useShowToast, useUIActions,
  
  // Auth Store - Autentica√ß√£o
  useIsSignedIn, useAuthUser, useAuthLoading,
  
  // Locale Store - Idioma/i18n
  useLocale, useSetLocale, useLocaleActions
} from '@/store';
```

### Estrutura do Store

```
src/store/
‚îú‚îÄ‚îÄ index.ts           # Exporta√ß√µes principais e inicializa√ß√£o
‚îú‚îÄ‚îÄ app-store.ts       # Dados da aplica√ß√£o e prefer√™ncias
‚îú‚îÄ‚îÄ ui-store.ts        # Estado da UI e intera√ß√µes
‚îú‚îÄ‚îÄ auth-store.ts      # Estado de autentica√ß√£o
‚îú‚îÄ‚îÄ locale-store.ts    # Idioma e localiza√ß√£o
‚îî‚îÄ‚îÄ types.ts           # Defini√ß√µes TypeScript
```

## üöÄ Exemplos de Uso

### Uso B√°sico do Store

```typescript
import { useTheme, useSetTheme, useShowToast } from '@/store';

function MeuComponente() {
  const temaAtual = useTheme();
  const setTema = useSetTheme();
  const mostrarToast = useShowToast();

  const handleToggleTema = () => {
    const novoTema = temaAtual === 'light' ? 'dark' : 'light';
    setTema(novoTema);
    mostrarToast({
      type: 'success',
      message: `Alterado para tema ${novoTema}`
    });
  };

  return (
    <button onClick={handleToggleTema}>
      Tema atual: {temaAtual}
    </button>
  );
}
```

### Atualiza√ß√µes Complexas de Estado

```typescript
import { useAppActions, useUser } from '@/store';

function PreferenciasUsuario() {
  const usuario = useUser();
  const { updatePreferences, addNotification } = useAppActions();

  const handleSalvarPreferencias = async (novasPrefs) => {
    try {
      await updatePreferences(novasPrefs);
      addNotification({
        type: 'success',
        title: 'Configura√ß√µes Salvas',
        message: 'Suas prefer√™ncias foram atualizadas'
      });
    } catch (error) {
      addNotification({
        type: 'error',
        title: 'Falha ao Salvar',
        message: 'N√£o foi poss√≠vel salvar as prefer√™ncias'
      });
    }
  };

  return (
    <div>
      <h2>Bem-vindo, {usuario?.fullName}</h2>
      {/* Formul√°rio de prefer√™ncias */}
    </div>
  );
}
```

### Gerenciamento de Locale/Idioma

```typescript
import { useLocaleSync } from '@/hooks/useLocaleSync';
import { useLocale } from '@/store';

function SeletorIdioma() {
  const localeAtual = useLocale();
  const { setLocale, availableLocales } = useLocaleSync();

  return (
    <select 
      value={localeAtual} 
      onChange={(e) => setLocale(e.target.value)}
    >
      {availableLocales.map(locale => (
        <option key={locale} value={locale}>
          {locale === 'pt-BR' ? 'Portugu√™s' : 'English'}
        </option>
      ))}
    </select>
  );
}
```

## üîß Padr√µes Avan√ßados

### Seletores Customizados (Otimizados)

```typescript
import { useUIStore } from '@/store/ui-store';
import { useMemo } from 'react';

// ‚úÖ Bom: Seletor otimizado com memoiza√ß√£o
function useSidebarOtimizada() {
  return useUIStore(
    useMemo(
      () => (state) => ({
        isOpen: state.sidebarOpen,
        isCollapsed: state.sidebarCollapsed,
        isPinned: state.sidebarPinned
      }),
      []
    )
  );
}

// ‚ùå Ruim: Cria novo objeto a cada render
function useSidebarRuim() {
  return useUIStore((state) => ({
    isOpen: state.sidebarOpen,
    isCollapsed: state.sidebarCollapsed,
    isPinned: state.sidebarPinned
  }));
}
```

### Sincroniza√ß√£o de Store

```typescript
// Sincroniza√ß√£o de tema com next-themes
import { useThemeSync } from '@/hooks/useThemeSync';

function App() {
  // Sincroniza automaticamente o tema Zustand com next-themes
  const { theme, setTheme } = useThemeSync();
  
  return <div className={theme}>...</div>;
}
```

## üì° Integra√ß√£o com Bibliotecas Externas

### Autentica√ß√£o Clerk

```typescript
// Sincroniza√ß√£o autom√°tica no ZustandProvider
import { useStoreSync } from '@/hooks/useStoreSync';

function AuthSync() {
  useStoreSync(); // Sincroniza usu√°rio Clerk com store auth Zustand
  return null;
}
```

### Internacionaliza√ß√£o Next.js

```typescript
// Sincroniza√ß√£o autom√°tica de locale
import { useLocaleSync } from '@/hooks/useLocaleSync';

function LocaleSync() {
  useLocaleSync(); // Sincroniza next-intl com store locale Zustand
  return null;
}
```

## üõ†Ô∏è Melhores Pr√°ticas

### 1. Use Seletores Individuais

```typescript
// ‚úÖ Bom: Seletores individuais para melhor performance
const tema = useTheme();
const isCarregando = useLoading();

// ‚ùå Evite: Seletores de objeto que causam re-renders desnecess√°rios
const { tema, isCarregando } = useUIState();
```

### 2. Memoize Seletores Complexos

```typescript
// ‚úÖ Bom: Seletor memoizado para estado derivado
const notificacoesFiltradas = useAppStore(
  useMemo(
    () => (state) => state.notifications.filter(n => !n.read),
    []
  )
);
```

### 3. Use Actions ao Inv√©s de setState Direto

```typescript
// ‚úÖ Bom: Use m√©todos de a√ß√£o
const mostrarToast = useShowToast();
mostrarToast({ type: 'success', message: 'Feito!' });

// ‚ùå Evite: Muta√ß√£o direta do estado
useUIStore.setState({ 
  toasts: [...useUIStore.getState().toasts, novoToast] 
});
```

### 4. Organize Estado Relacionado

```typescript
// ‚úÖ Bom: Agrupe estado relacionado no mesmo store
interface UIState {
  theme: 'light' | 'dark' | 'system';
  sidebarOpen: boolean;
  sidebarCollapsed: boolean;
  // Estado de UI relacionado junto
}

// ‚ùå Evite: Dividir estado relacionado entre stores
```

## üîç Debugging

### Integra√ß√£o com DevTools

Zustand integra automaticamente com Redux DevTools para debugging:

```typescript
// DevTools s√£o habilitadas em desenvolvimento
import { useUIStore } from '@/store/ui-store';

// Visualize mudan√ßas de estado na extens√£o Redux DevTools do navegador
```

### Inspe√ß√£o do Estado do Store

```typescript
// Acesse o estado atual para debugging
const estadoAtual = useUIStore.getState();
console.log('Estado atual da UI:', estadoAtual);
```

## üì¶ Persist√™ncia

### Persist√™ncia Autom√°tica

```typescript
// Certo estado √© automaticamente persistido
const estadoPersistido = {
  theme: state.theme,                    // Prefer√™ncias da UI
  sidebarCollapsed: state.sidebarCollapsed,
  locale: state.locale,                  // Prefer√™ncia de idioma
  userPreferences: state.preferences     // Configura√ß√µes do usu√°rio
};
```

### Persist√™ncia Customizada

```typescript
// Adicione persist√™ncia customizada ao store
export const useCustomStore = create(
  persist(
    (set) => ({
      dadosCustomizados: null,
      setDadosCustomizados: (dados) => set({ dadosCustomizados: dados })
    }),
    {
      name: 'custom-store',
      partialize: (state) => ({ dadosCustomizados: state.dadosCustomizados })
    }
  )
);
```

## üß™ Testes

### Testando Componentes com Stores

```typescript
import { renderWithProviders } from '@/test-utils';
import { useUIStore } from '@/store/ui-store';

test('componente atualiza quando tema muda', () => {
  const { getByText } = renderWithProviders(<MeuComponente />);
  
  // Aciona atualiza√ß√£o do store
  act(() => {
    useUIStore.getState().setTheme('dark');
  });
  
  expect(getByText(/tema escuro/i)).toBeInTheDocument();
});
```

### Mockando Stores

```typescript
// Mock do store para testes
jest.mock('@/store', () => ({
  useTheme: () => 'light',
  useSetTheme: () => jest.fn(),
  useShowToast: () => jest.fn()
}));
```

## üö® Armadilhas Comuns

### 1. Performance de Seletor de Objeto

```typescript
// ‚ùå Ruim: Cria novo objeto a cada render
const estado = useStore(state => ({ a: state.a, b: state.b }));

// ‚úÖ Bom: Use seletores individuais
const a = useStore(state => state.a);
const b = useStore(state => state.b);
```

### 2. Actions Ass√≠ncronas

```typescript
// ‚úÖ Bom: Tratamento adequado de a√ß√£o ass√≠ncrona
const adicionarNotificacaoAsync = async (mensagem: string) => {
  set(state => ({ isLoading: true }));
  try {
    await api.sendNotification(mensagem);
    set(state => ({ 
      notifications: [...state.notifications, novaNotificacao],
      isLoading: false 
    }));
  } catch (error) {
    set(state => ({ error, isLoading: false }));
  }
};
```

### 3. Inicializa√ß√£o do Store

```typescript
// ‚úÖ Bom: Use ZustandProvider para inicializa√ß√£o
function App() {
  return (
    <ZustandProvider>
      <SeuApp />
    </ZustandProvider>
  );
}
```

## üìö Refer√™ncias

- [Documenta√ß√£o Zustand](https://github.com/pmndrs/zustand)
- [Melhores Pr√°ticas de Performance React](https://react.dev/learn/render-and-commit)
- [TypeScript com Zustand](https://github.com/pmndrs/zustand#typescript)
- [Exemplos de Gerenciamento de Estado](/src/components/StateManagement/Zustand.tsx)